## Как установить и настроить проект

#### Данный проект можно поднять в docker для этого нужно вызывать команды из корневого каталога проекта

#### .env добавлен в репозиторий только для того, что бы не заниматься настройкой перед запуском

#### SCRF токен отключен для  добавлен в репозиторий только для того, что бы не заниматься настройкой перед запуском

```cli
docker compose build
docker compose up
```

### Конфигурации docker находятся в директории ```/docker```

``` dir
/docker/nginx/conf.d/default.conf - когфигурация nginx резервирует :89 порт на хост машин
```

База данных тоже будет создана в docker под названием `skilla` резервирует порт 3333, подключиться к БД можно через любой клиент по порту `3333` `-u root -p root`

### Обратиться к API можно через любой REST клиент по адресу http://localhost:89

Установка пакетов из composer должна произойти автоматически (если этого не произошло запустите команду)

```bash
docker exec -i php8.3_skilla composer install
```

Заполнение БД тестовыми данными запустите команды

```bash
docker exec -i php8.3_skilla php artisan migrate
docker exec -i php8.3_skilla php artisan db:seed
```

Перед началом работы с API необходимо создать клиента Laravel Passport сделать это можно напрямую в контейнере

Клиентов можно создать для двух моделей `Users` и `Worker`, вторые для выпуска токенов и авторизации в сокетах

```bash
docker exec -i php8.3_skilla php artisan passport:client --password
```
Полученные данные необходимы для дальнейшего выпуска токенов в полях `client_id` и `client_secret`

## API взаимодействие

#### CSRF токен по умолчанию отключен для `/api/*` для удобства разработки и работы с REST клиентов

### Создать токен авторизации

#### Данные тестовых пользователей

| Параметр   | Тип             |
|:-----------|:----------------|
| `username` | admin@admin.com |
| `password` | admin           |

| Параметр   | Тип               |
|:-----------|:------------------|
| `username` | worker@worker.com |
| `password` | worker            |

```http
POST /passport/token
```

| Параметр        | Тип      | Описание                                 |
|:----------------|:---------|:-----------------------------------------|
| `username`      | `string` | **Обязательный**. email пользователя     |
| `password`      | `string` | **Обязательный**. пароль пользователя    |
| `grand_type`    | `string` | **Обязательный**. тип доступа "password" |
| `client_id`     | `string` | **Обязательный**. Идентификатор клиента  |
| `client_secret` | `string` | **Обязательный**. Секрет клиента         |

#### Заголовки необходимые для работы с API после авторизации

| Ключ            | Значение           | Описание                                |
|:----------------|:-------------------|:----------------------------------------|
| `Accept`        | `application/json` | **Необязательный**.                     |
| `Authorization` | `Bearer {{TOKEN}}` | **Обязательный**. Заголовок авторизации |

### Отозвать токен

```http
POST /logout
```

### Создать заказ в случае успеха вернёт созданный заказ

```http
POST /api/order
```

| Параметр         | Тип      | Описание                                                |
|:-----------------|:---------|:--------------------------------------------------------|
| `type_id`        | `bigint` | **Обязательный**. Идентификатор типа заказа             |
| `partnership_id` | `bigint` | **Обязательный**. Идентификатор партнера                |
| `description`    | `string` | **Необязательный**. Описание                            |
| `date`           | `string` | **Обязательный**. Дата в формате 1978-06-20             |
| `address`        | `string` | **Обязательный**. Адрес                                 |
| `amount`         | `int`    | **Обязательный**. Стоимость                             |
| `status`         | `string` | **Необязательный**. Статус заказа по умолчанию "Создан" |

| Параметр         | Тип      | Описание                        |
|:-----------------|:---------|:--------------------------------|
| `type_id`        | `bigint` | Идентификатор типа заказа       |
| `partnership_id` | `bigint` | Идентификатор партнера          |
| `description`    | `string` | Описание                        |
| `date`           | `string` | Дата в формате 1978-06-20       |
| `address`        | `string` | Адрес                           |
| `amount`         | `int`    | Стоимость                       |
| `status`         | `string` | Статус заказа                   |
| `created_at`     | `date`   | Дата создания                   |
| `updated_at`     | `date`   | Дата обновления                 |
| `id`             | `bigint` | Идентификатор заказа обновления |

### Назначить исполнителя на заказ

```http
POST /api/order-bind-worker
```

| Параметр    | Тип      | Описание                                    |
|:------------|:---------|:--------------------------------------------|
| `order_id`  | `bigint` | **Обязательный**. Идентификатор заказа      |
| `worker_id` | `bigint` | **Обязательный**. Идентификатор исполнителя |
| `amount`    | `int`    | **Обязательный**. Стоимость                 |

| Параметр  | Тип    | Описание                        |
|:----------|:-------|:--------------------------------|
| `success` | `bool` | Успешно ли произошло назначение |

### Получить отфильтрованных исполнителей

```http
GET /api/workers
GET /api/workers?type_id[]=1&type_id[]=2
GET /api/workers?type_id=2
```

| Параметр  | Тип              | Описание                                                                                                       |
|:----------|:-----------------|:---------------------------------------------------------------------------------------------------------------|
| `type_id` | `string` `array` | **Необязательный**. Возвращает исполнителей с фильтрацией </br> в зависти если хотя бы 1 тип работ выполняется |

#### Ответ массив с типом

| Параметр      | Тип      | Описание                  |
|:--------------|:---------|:--------------------------|
| `id`          | `bigint` | Идентификатор исполнителя |
| `name`        | `string` | Имя исполнителя           |
| `second_name` | `string` | Второе имя исполнителя    |
| `surname`     | `string` | Фамилия                   |
| `phone`       | `string` | Телефон                   |
| `created_at`  | `date`   | Дата создания             |
| `updated_at`  | `date`   | Дата обновления           |

### Обновить статус заказа
#### После вызова событие для отправки сведений на WS обновление поместится в очередь

```http
PUT /api/order
```

| Параметр   | Тип      | Описание                               |
|:-----------|:---------|:---------------------------------------|
| `order_id` | `int`    | **Обязательный**. Идентификатор заказа |
| `status`   | `string` | **Обязательный**. Новый статус заказа  |

| Параметр  | Тип      | Описание                      |
|:----------|:---------|:------------------------------|
| `success` | `bool`   | Идентификатор исполнителя     |
| `error`   | `string` | Ошибка при обновлении статуса |

## Работа с WebSocket

### Выделенный порт для работы с WebSocket :8089

#### Запустить можно командой

```bash
docker exec -i php8.3_skilla php artisan reverb:start --debug
```

`--debug` для работы из Postman что бы видеть и добавлять токен выпущенный при подписке на событие

### Подключение к WebSocket ключик из .env[REVERB_APP_KEY]

```ws
ws://localhost:89/app/kfaaz4zwbkm1u5hl4s3k
```

### Выпустить токен подключения к каналу

```php
POST http://localhost:89/broadcasting/auth
```

| Параметр       | Тип      | Описание                                                           |
|:---------------|:---------|:-------------------------------------------------------------------|
| `socket_id`    | `string` | **Обязательный**. Идентификатор сокета выпущенного при подключении |
| `channel_name` | `string` | **Обязательный**. Worker.{id}                                      |
#### Заголовки необходимые для работы с сокетами

| Ключ            | Значение           | Описание                                            |
|:----------------|:-------------------|:----------------------------------------------------|
| `Authorization` | `Bearer {{TOKEN}}` | **Обязательный**. Токен авторизованного исполнителя |


### Теперь можно подписаться на событие в ранее открытом соединении WS
```json
{
"event":"pusher:subscribe",
    "data":{
        "auth":"тут ключик полученный при авторизации",
        "channel":"Worker.{id}"
    }
}
```
#### Полноценно прослушать сокет через Postman не удалось Echo уже настраивать не стал
